<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile & Settings</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Profile specific styles */
        .tab-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem 1rem;
            text-align: left;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.2s;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .tab-btn:hover {
            background-color: var(--bg-element-hover);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background-color: var(--bg-element-active);
            color: var(--text-primary);
        }

        .tab-btn i {
            width: 1.25rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app" class="app-container hidden">
        <!-- Sidebar Navigation -->
        <aside class="sidebar open" id="sidebar">
            <div class="sidebar-header">
                <div class="flex items-center gap-2 font-semibold">
                    <div class="w-8 h-8 rounded bg-accent-solid text-inverse flex items-center justify-center">
                        <i class="fas fa-cog"></i>
                    </div>
                    <span>Settings</span>
                </div>
            </div>
            <nav class="sidebar-content" id="tabs">
                <!-- Tabs injected here -->
            </nav>
            <div class="sidebar-footer">
                <button id="logoutBtn" class="btn btn-ghost w-full justify-start text-error">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="chat-header">
                <div class="flex items-center gap-3">
                    <button class="btn btn-ghost p-1" id="mobileMenuBtn" title="Toggle sidebar"><i class="fas fa-bars"></i></button>
                    <h3 class="font-semibold text-sm md:text-base truncate max-w-[200px]" id="pageTitle">Profile</h3>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <div id="userBadge" class="text-sm font-medium px-3 py-1 rounded-md bg-element border border-subtle"></div>
                    <button onclick="window.location.href='/'" class="btn btn-secondary text-sm">
                        <i class="fas fa-arrow-left"></i> Back to Chat
                    </button>
                </div>
            </header>
            <div id="content" class="p-6 overflow-y-auto h-full">
                <!-- Content injected here -->
            </div>
        </main>
    </div>

<script>
    // Initialize Theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    const API_BASE = window.location.origin;
    const allTabs = [
        { id: 'profile', label: 'Profile', icon: 'fa-user', adminOnly: false },
        { id: 'clients', label: 'Clients', icon: 'fa-building', adminOnly: false },
        { id: 'audit', label: 'Audit Logs', icon: 'fa-list-check', adminOnly: true },
        { id: 'users', label: 'Users', icon: 'fa-user-shield', adminOnly: true },
        { id: 'evaluation', label: 'Evaluation', icon: 'fa-vial', adminOnly: true },
        { id: 'stats', label: 'Stats', icon: 'fa-chart-line', adminOnly: true },
    ];
    
    let authToken = localStorage.getItem('auth_token');
    let currentTab = 'profile';
    let currentUserInfo = null;

    const appView = document.getElementById('app');
    const logoutBtn = document.getElementById('logoutBtn');
    const userBadge = document.getElementById('userBadge');
    const content = document.getElementById('content');
    const tabsContainer = document.getElementById('tabs');
    const pageTitle = document.getElementById('pageTitle');
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');

    // Mobile menu toggle
    mobileMenuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('open');
    });

    function redirectToLogin() {
        window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
    }

    function getVisibleTabs() {
        if (currentUserInfo && currentUserInfo.is_superuser) {
            return allTabs;
        }
        return allTabs.filter(t => !t.adminOnly);
    }

    function rebuildTabs() {
        const visibleTabs = getVisibleTabs();
        tabsContainer.innerHTML = visibleTabs.map(t => `
            <button class="tab-btn ${t.id === currentTab ? 'active' : ''}" data-id="${t.id}">
                <i class="fa ${t.icon}"></i> ${t.label}
            </button>
        `).join('');
        
        // Update page title
        const activeTab = visibleTabs.find(t => t.id === currentTab);
        if (activeTab) pageTitle.textContent = activeTab.label;

        if (!visibleTabs.find(t => t.id === currentTab)) {
            currentTab = visibleTabs[0]?.id || 'profile';
            rebuildTabs(); // Recurse once to fix selection
        }
    }
    
    tabsContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('button.tab-btn');
        if (!btn) return;
        currentTab = btn.dataset.id;
        rebuildTabs();
        loadTab();
    });

    logoutBtn.addEventListener('click', () => {
        authToken = null;
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user');
        redirectToLogin();
    });

    function getHeaders() {
        return { 'Content-Type': 'application/json', Authorization: `Bearer ${authToken}` };
    }
    
    async function bootstrap() {
        if (!authToken) {
            redirectToLogin();
            return;
        }
        
        try {
            const me = await fetch(`${API_BASE}/auth/me`, { headers: getHeaders() });
            if (!me.ok) throw new Error('Auth failed');
            const user = await me.json();
            currentUserInfo = user;
            userBadge.textContent = `${user.username} (${user.is_superuser ? 'Admin' : 'User'})`;
            
            appView.classList.remove('hidden');
            rebuildTabs();
            loadTab();
        } catch (err) {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            redirectToLogin();
        }
    }

    async function loadTab() {
        content.innerHTML = '<div class="flex items-center justify-center p-8"><div class="loading-spinner"></div></div>';
        if (currentTab === 'profile') return renderProfile();
        if (currentTab === 'audit') return renderAudit();
        if (currentTab === 'users') return renderUsers();
        if (currentTab === 'clients') return renderClients();
        if (currentTab === 'evaluation') return renderEvaluation();
        if (currentTab === 'stats') return renderStats();
    }

    // ============================================================
    // PROFILE TAB
    // ============================================================
    async function renderProfile() {
        const user = currentUserInfo;
        const initials = user.username ? user.username.substring(0, 2).toUpperCase() : 'U';
        
        content.innerHTML = `
            <div class="flex flex-col gap-6 max-w-3xl mx-auto">
                <!-- Profile Card -->
                <div class="panel flex items-center gap-6">
                    <div class="w-20 h-20 rounded-full bg-accent-solid text-inverse flex items-center justify-center text-3xl font-bold">
                        ${initials}
                    </div>
                    <div>
                        <h2 class="text-xl font-bold mb-1">${user.username}</h2>
                        <p class="text-muted mb-2">${user.email || 'No email set'}</p>
                        <span class="text-xs px-2 py-1 rounded bg-element-active border border-subtle font-medium">
                            ${user.is_superuser ? 'Administrator' : 'User'}
                        </span>
                    </div>
                </div>
                
                <!-- Details -->
                <div class="panel">
                    <h3 class="text-lg font-semibold mb-4">Account Details</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <tbody>
                                <tr class="border-b border-subtle"><td class="p-3 text-muted w-1/3">User ID</td><td class="p-3 font-mono text-sm">${user.id}</td></tr>
                                <tr class="border-b border-subtle"><td class="p-3 text-muted">Username</td><td class="p-3">${user.username}</td></tr>
                                <tr class="border-b border-subtle"><td class="p-3 text-muted">Email</td><td class="p-3">${user.email || '-'}</td></tr>
                                <tr class="border-b border-subtle"><td class="p-3 text-muted">Status</td><td class="p-3"><span class="text-success-text bg-success-bg px-2 py-0.5 rounded text-xs">Active</span></td></tr>
                                <tr><td class="p-3 text-muted">Created</td><td class="p-3">${user.created_at ? new Date(user.created_at).toLocaleDateString() : '-'}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Password -->
                <div class="panel">
                    <h3 class="text-lg font-semibold mb-4">Change Password</h3>
                    <div class="flex flex-col gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-secondary">Current Password</label>
                            <input id="currentPass" type="password" placeholder="Enter current password">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1 text-secondary">New Password</label>
                                <input id="newPass" type="password" placeholder="Enter new password">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1 text-secondary">Confirm New Password</label>
                                <input id="confirmPass" type="password" placeholder="Confirm new password">
                            </div>
                        </div>
                        <div class="flex items-center gap-4 mt-2">
                            <button class="btn btn-primary" id="changePassBtn">Update Password</button>
                            <span id="passMsg" class="text-sm text-muted"></span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('changePassBtn').addEventListener('click', async () => {
            const currentPass = document.getElementById('currentPass').value;
            const newPass = document.getElementById('newPass').value;
            const confirmPass = document.getElementById('confirmPass').value;
            const msg = document.getElementById('passMsg');
            
            if (!currentPass || !newPass) {
                msg.textContent = 'Please fill in all fields';
                msg.className = 'text-sm text-error-text';
                return;
            }
            if (newPass !== confirmPass) {
                msg.textContent = 'New passwords do not match';
                msg.className = 'text-sm text-error-text';
                return;
            }
            if (newPass.length < 6) {
                msg.textContent = 'Password must be at least 6 characters';
                msg.className = 'text-sm text-error-text';
                return;
            }
            
            msg.textContent = 'Updating...';
            msg.className = 'text-sm text-muted';
            
            try {
                const loginRes = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUserInfo.username, password: currentPass }),
                });
                if (!loginRes.ok) throw new Error('Current password is incorrect');
                
                const res = await fetch(`${API_BASE}/auth/change-password`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ current_password: currentPass, new_password: newPass }),
                });
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed to update');
                
                msg.textContent = 'Password updated successfully!';
                msg.className = 'text-sm text-success-text';
                document.getElementById('currentPass').value = '';
                document.getElementById('newPass').value = '';
                document.getElementById('confirmPass').value = '';
            } catch (err) {
                msg.textContent = err.message;
                msg.className = 'text-sm text-error-text';
            }
        });
    }

    // ============================================================
    // AUDIT TAB
    // ============================================================
    async function renderAudit() {
        content.innerHTML = `
            <div class="flex flex-col gap-6">
                <div class="panel">
                    <h3 class="text-lg font-semibold mb-4">Filters</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Username</label><input id="filterUser" placeholder="Filter by user" /></div>
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Action</label><select id="filterAction"><option value="">All Actions</option></select></div>
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Method</label><select id="filterMethod"><option value="">All Methods</option><option>GET</option><option>POST</option><option>PUT</option><option>PATCH</option><option>DELETE</option></select></div>
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Status</label><input id="filterStatus" type="number" placeholder="e.g. 200" /></div>
                        <button class="btn btn-secondary w-full" id="applyFilters">Apply Filters</button>
                    </div>
                </div>
                <div class="panel" id="auditPanel">
                    <div class="flex items-center justify-center p-8"><div class="loading-spinner"></div></div>
                </div>
            </div>`;
        
        try {
            const actRes = await fetch(`${API_BASE}/admin/audit-logs/actions`, { headers: getHeaders() });
            if (actRes.ok) {
                const actionsData = await actRes.json();
                const actions = actionsData.actions || [];
                const select = document.getElementById('filterAction');
                actions.forEach(a => { const opt = document.createElement('option'); opt.value = a; opt.textContent = a; select.appendChild(opt); });
            }
        } catch (e) {}
        
        document.getElementById('applyFilters').addEventListener('click', loadAuditLogs);
        loadAuditLogs();
    }
    
    async function loadAuditLogs() {
        const user = document.getElementById('filterUser')?.value || '';
        const action = document.getElementById('filterAction')?.value || '';
        const method = document.getElementById('filterMethod')?.value || '';
        const status = document.getElementById('filterStatus')?.value || '';
        
        let url = `${API_BASE}/admin/audit-logs?page=1&page_size=50`;
        if (user) url += `&username=${encodeURIComponent(user)}`;
        if (action) url += `&action=${encodeURIComponent(action)}`;
        if (method) url += `&method=${encodeURIComponent(method)}`;
        if (status) url += `&status_code=${status}`;
        
        try {
            const res = await fetch(url, { headers: getHeaders() });
            if (!res.ok) throw new Error('Failed to load logs');
            const data = await res.json();
            const logs = data.logs || [];
            const rows = logs.map(log => `
                <tr class="border-b border-subtle last:border-0 hover:bg-element-hover">
                    <td class="p-3">${log.username || '-'}</td>
                    <td class="p-3"><span class="px-2 py-0.5 rounded bg-element-active text-xs font-mono">${log.action}</span></td>
                    <td class="p-3 text-sm font-mono text-muted">${log.method || ''} ${log.path || ''}</td>
                    <td class="p-3"><span class="${log.status_code >= 400 ? 'text-error-text' : 'text-success-text'}">${log.status_code || ''}</span></td>
                    <td class="p-3 text-sm text-muted">-</td>
                    <td class="p-3 text-sm text-muted">${new Date(log.timestamp).toLocaleString()}</td>
                </tr>
            `).join('');
            document.getElementById('auditPanel').innerHTML = `
                <h3 class="text-lg font-semibold mb-4">Recent Logs (${data.total})</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead><tr class="bg-element-hover border-b border-subtle"><th class="p-3 font-medium text-secondary">User</th><th class="p-3 font-medium text-secondary">Action</th><th class="p-3 font-medium text-secondary">Path</th><th class="p-3 font-medium text-secondary">Status</th><th class="p-3 font-medium text-secondary">Duration</th><th class="p-3 font-medium text-secondary">Time</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="6" class="p-4 text-center text-muted">No logs found</td></tr>'}</tbody>
                    </table>
                </div>
            `;
        } catch (err) {
            document.getElementById('auditPanel').innerHTML = `<div class="p-4 text-error-text bg-error-bg rounded-md">${err.message}</div>`;
        }
    }

    // ============================================================
    // USERS TAB
    // ============================================================
    async function renderUsers() {
        content.innerHTML = `
            <div class="flex flex-col gap-6">
                <div class="panel" id="userList">
                    <div class="flex items-center justify-center p-8"><div class="loading-spinner"></div></div>
                </div>
                <div class="panel">
                    <h3 class="text-lg font-semibold mb-4">Create User</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Username</label><input id="newUser" placeholder="jane" /></div>
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Email</label><input id="newEmail" placeholder="jane@example.com" /></div>
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Password</label><input id="newPass" type="password" /></div>
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Role</label><select id="newRole"><option value="false">User</option><option value="true">Admin</option></select></div>
                    </div>
                    <div class="mt-4 flex items-center gap-4">
                        <button class="btn btn-primary" id="createUserBtn">Create User</button>
                        <span id="userMsg" class="text-sm text-muted"></span>
                    </div>
                </div>
                
                <!-- Edit Modal (Inline Panel) -->
                <div class="panel hidden" id="editUserPanel">
                    <h3 class="text-lg font-semibold mb-4">Edit User</h3>
                    <input type="hidden" id="editUserId" />
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Email</label><input id="editEmail" /></div>
                        <div><label class="block text-sm font-medium mb-1 text-secondary">New Password</label><input id="editPass" type="password" placeholder="Leave blank to keep" /></div>
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Role</label><select id="editRole"><option value="false">User</option><option value="true">Admin</option></select></div>
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Status</label><select id="editStatus"><option value="true">Active</option><option value="false">Disabled</option></select></div>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button class="btn btn-primary" id="saveUserBtn">Save Changes</button>
                        <button class="btn btn-ghost" id="cancelEditBtn">Cancel</button>
                        <span id="editMsg" class="text-sm text-muted ml-2"></span>
                    </div>
                </div>
            </div>`;

        document.getElementById('createUserBtn').addEventListener('click', async () => {
            const username = document.getElementById('newUser').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const password = document.getElementById('newPass').value;
            const is_superuser = document.getElementById('newRole').value === 'true';
            const msg = document.getElementById('userMsg');
            msg.textContent = '...';
            try {
                const res = await fetch(`${API_BASE}/admin/users`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ username, email, password, is_superuser }),
                });
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed');
                msg.textContent = 'User created';
                msg.className = 'text-sm text-success-text';
                document.getElementById('newUser').value = '';
                document.getElementById('newEmail').value = '';
                document.getElementById('newPass').value = '';
                loadUserList();
            } catch (err) {
                msg.textContent = err.message;
                msg.className = 'text-sm text-error-text';
            }
        });
        
        document.getElementById('saveUserBtn').addEventListener('click', async () => {
            const userId = document.getElementById('editUserId').value;
            const email = document.getElementById('editEmail').value.trim() || null;
            const password = document.getElementById('editPass').value || null;
            const is_superuser = document.getElementById('editRole').value === 'true';
            const is_active = document.getElementById('editStatus').value === 'true';
            const msg = document.getElementById('editMsg');
            msg.textContent = '...';
            try {
                const body = { is_superuser, is_active };
                if (email) body.email = email;
                if (password) body.password = password;
                const res = await fetch(`${API_BASE}/admin/users/${userId}`, {
                    method: 'PATCH',
                    headers: getHeaders(),
                    body: JSON.stringify(body),
                });
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed');
                msg.textContent = 'Updated!';
                document.getElementById('editUserPanel').classList.add('hidden');
                loadUserList();
            } catch (err) {
                msg.textContent = err.message;
            }
        });
        
        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            document.getElementById('editUserPanel').classList.add('hidden');
        });

        loadUserList();
    }
    
    async function loadUserList() {
        try {
            const res = await fetch(`${API_BASE}/admin/users?limit=100`, { headers: getHeaders() });
            if (!res.ok) throw new Error('Failed to load users');
            const data = await res.json();
            const users = data.users || [];
            const rows = users.map(u => `
                <tr class="border-b border-subtle last:border-0 hover:bg-element-hover" data-user='${JSON.stringify(u).replace(/'/g, "&#39;")}'>
                    <td class="p-3 font-medium">${u.username}</td>
                    <td class="p-3 text-muted">${u.email || '-'}</td>
                    <td class="p-3"><span class="px-2 py-0.5 rounded text-xs ${u.is_superuser ? 'bg-accent-solid text-inverse' : 'bg-element-active'}">${u.is_superuser ? 'Admin' : 'User'}</span></td>
                    <td class="p-3"><span class="text-xs ${u.is_active ? 'text-success-text' : 'text-error-text'}">${u.is_active ? 'Active' : 'Disabled'}</span></td>
                    <td class="p-3 text-sm text-muted">${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}</td>
                    <td class="p-3"><button class="btn btn-secondary text-xs py-1 px-2 edit-user-btn">Edit</button></td>
                </tr>
            `).join('');
            document.getElementById('userList').innerHTML = `
                <h3 class="text-lg font-semibold mb-4">Users (${users.length})</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead><tr class="bg-element-hover border-b border-subtle"><th class="p-3 font-medium text-secondary">Username</th><th class="p-3 font-medium text-secondary">Email</th><th class="p-3 font-medium text-secondary">Role</th><th class="p-3 font-medium text-secondary">Status</th><th class="p-3 font-medium text-secondary">Created</th><th class="p-3 font-medium text-secondary">Actions</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="6" class="p-4 text-center text-muted">No users</td></tr>'}</tbody>
                    </table>
                </div>
            `;
            
            document.querySelectorAll('.edit-user-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    const user = JSON.parse(row.dataset.user);
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editEmail').value = user.email || '';
                    document.getElementById('editPass').value = '';
                    document.getElementById('editRole').value = user.is_superuser ? 'true' : 'false';
                    document.getElementById('editStatus').value = user.is_active ? 'true' : 'false';
                    document.getElementById('editUserPanel').classList.remove('hidden');
                    document.getElementById('editMsg').textContent = `Editing: ${user.username}`;
                    document.getElementById('editUserPanel').scrollIntoView({ behavior: 'smooth' });
                });
            });
        } catch (err) {
            document.getElementById('userList').innerHTML = `<div class="p-4 text-error-text bg-error-bg rounded-md">${err.message}</div>`;
        }
    }

    // ============================================================
    // CLIENTS TAB
    // ============================================================
    let allUsers = []; 
    
    async function renderClients() {
        const isAdmin = currentUserInfo && currentUserInfo.is_superuser;
        
        content.innerHTML = `
            <div class="flex flex-col gap-6">
                <div class="panel" id="clientList">
                    <div class="flex items-center justify-center p-8"><div class="loading-spinner"></div></div>
                </div>
                ${isAdmin ? `
                <div class="panel">
                    <h3 class="text-lg font-semibold mb-4">Create Client</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Name</label><input id="newClientName" placeholder="Acme Corp" /></div>
                        <div><label class="block text-sm font-medium mb-1 text-secondary">Aliases (comma-separated)</label><input id="newClientAliases" placeholder="acme, acme-corp" /></div>
                    </div>
                    <div class="mt-4 flex items-center gap-4">
                        <button class="btn btn-primary" id="createClientBtn">Create Client</button>
                        <span id="clientMsg" class="text-sm text-muted"></span>
                    </div>
                </div>
                
                <div class="panel" id="userAccessPanel">
                    <h3 class="text-lg font-semibold mb-4">User Access Management</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-secondary">Select Client</label>
                            <select id="accessClientSelect"><option value="">-- Select a client --</option></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1 text-secondary">Select User</label>
                            <select id="accessUserSelect"><option value="">-- Select a user --</option></select>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button class="btn btn-primary" id="assignUserBtn">Grant Access</button>
                        <button class="btn btn-secondary text-error-text" id="revokeUserBtn">Revoke Access</button>
                    </div>
                    <div id="accessMsg" class="text-sm text-muted mt-2"></div>
                    <div id="clientUsersPreview" class="mt-4"></div>
                </div>
                ` : ''}
            </div>`;

        if (isAdmin) {
            document.getElementById('createClientBtn').addEventListener('click', async () => {
                const name = document.getElementById('newClientName').value.trim();
                const aliasesStr = document.getElementById('newClientAliases').value.trim();
                const aliases = aliasesStr ? aliasesStr.split(',').map(a => a.trim()).filter(a => a) : [];
                const msg = document.getElementById('clientMsg');
                msg.textContent = '...';
                try {
                    const res = await fetch(`${API_BASE}/clients`, {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify({ name, aliases, metadata: {} }),
                    });
                    if (!res.ok) throw new Error((await res.json()).detail || 'Failed');
                    msg.textContent = 'Client created';
                    msg.className = 'text-sm text-success-text';
                    document.getElementById('newClientName').value = '';
                    document.getElementById('newClientAliases').value = '';
                    loadClientList();
                } catch (err) {
                    msg.textContent = err.message;
                    msg.className = 'text-sm text-error-text';
                }
            });
            
            document.getElementById('assignUserBtn').addEventListener('click', assignUserToClient);
            document.getElementById('revokeUserBtn').addEventListener('click', revokeUserFromClient);
            document.getElementById('accessClientSelect').addEventListener('change', loadClientUsersPreview);
            
            loadUsersForAccessPanel();
        }

        loadClientList();
    }
    
    async function loadUsersForAccessPanel() {
        try {
            const res = await fetch(`${API_BASE}/admin/users?limit=200`, { headers: getHeaders() });
            if (res.ok) {
                const data = await res.json();
                allUsers = data.users || [];
                const userSelect = document.getElementById('accessUserSelect');
                if (userSelect) {
                    userSelect.innerHTML = '<option value="">-- Select a user --</option>';
                    allUsers.forEach(u => {
                        const opt = document.createElement('option');
                        opt.value = u.id;
                        opt.textContent = `${u.username} ${u.is_superuser ? '(Admin)' : ''}`;
                        userSelect.appendChild(opt);
                    });
                }
            }
        } catch (err) { console.error(err); }
    }
    
    async function assignUserToClient() {
        const clientId = document.getElementById('accessClientSelect').value;
        const userId = document.getElementById('accessUserSelect').value;
        const msg = document.getElementById('accessMsg');
        
        if (!clientId || !userId) {
            msg.textContent = 'Please select both a client and a user';
            msg.className = 'text-error-text';
            return;
        }
        
        msg.textContent = 'Assigning...';
        msg.className = 'text-muted';
        
        try {
            const res = await fetch(`${API_BASE}/clients/${clientId}/users/${userId}`, {
                method: 'POST',
                headers: getHeaders(),
            });
            
            if (res.ok) {
                msg.textContent = 'User assigned successfully';
                msg.className = 'text-success-text';
                loadClientUsersPreview();
            } else {
                throw new Error((await res.json()).detail || 'Failed');
            }
        } catch (err) {
            msg.textContent = err.message;
            msg.className = 'text-error-text';
        }
    }
    
    async function revokeUserFromClient() {
        const clientId = document.getElementById('accessClientSelect').value;
        const userId = document.getElementById('accessUserSelect').value;
        const msg = document.getElementById('accessMsg');
        
        if (!clientId || !userId) {
            msg.textContent = 'Please select both a client and a user';
            msg.className = 'text-error-text';
            return;
        }
        
        if (!confirm('Revoke access?')) return;
        
        try {
            const res = await fetch(`${API_BASE}/clients/${clientId}/users/${userId}`, {
                method: 'DELETE',
                headers: getHeaders(),
            });
            
            if (res.ok) {
                msg.textContent = 'Access revoked successfully';
                msg.className = 'text-success-text';
                loadClientUsersPreview();
            } else {
                throw new Error((await res.json()).detail || 'Failed');
            }
        } catch (err) {
            msg.textContent = err.message;
            msg.className = 'text-error-text';
        }
    }
    
    async function loadClientUsersPreview() {
        const clientId = document.getElementById('accessClientSelect').value;
        const preview = document.getElementById('clientUsersPreview');
        
        if (!clientId) {
            preview.innerHTML = '';
            return;
        }
        
        preview.innerHTML = '<div class="text-sm text-muted">Loading users...</div>';
        
        try {
            const res = await fetch(`${API_BASE}/clients/${clientId}/users`, { headers: getHeaders() });
            if (res.ok) {
                const data = await res.json();
                const users = data.users || [];
                
                if (users.length === 0) {
                    preview.innerHTML = '<div class="p-3 bg-element rounded border border-subtle text-sm text-muted text-center">No users assigned</div>';
                } else {
                    const userChips = users.map(u => `
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-element-active border border-subtle text-xs">
                            <i class="fas fa-user text-muted"></i> ${u.username}
                            ${u.is_superuser ? '<i class="fas fa-shield-alt text-success-text"></i>' : ''}
                        </span>
                    `).join('');
                    
                    preview.innerHTML = `
                        <div class="p-3 bg-element rounded border border-subtle">
                            <div class="text-xs font-medium text-secondary uppercase tracking-wider mb-2">Users with access (${users.length})</div>
                            <div class="flex flex-wrap gap-2">${userChips}</div>
                        </div>
                    `;
                }
            }
        } catch (err) {
            preview.innerHTML = '<div class="text-sm text-error-text">Failed to load users</div>';
        }
    }

    async function loadClientList() {
        const isAdmin = currentUserInfo && currentUserInfo.is_superuser;
        
        try {
            const res = await fetch(`${API_BASE}/clients`, { headers: getHeaders() });
            if (!res.ok) throw new Error('Failed to load clients');
            const data = await res.json();
            const clients = data.clients || [];
            
            const accessSelect = document.getElementById('accessClientSelect');
            if (accessSelect) {
                accessSelect.innerHTML = '<option value="">-- Select a client --</option>';
                clients.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    accessSelect.appendChild(opt);
                });
            }
            
            const rows = clients.map(c => `
                <tr class="border-b border-subtle last:border-0 hover:bg-element-hover">
                    <td class="p-3 font-mono text-xs text-muted" title="${c.id}">${c.id.substring(0, 8)}...</td>
                    <td class="p-3 font-medium">${c.name}</td>
                    <td class="p-3 text-sm text-muted">${c.aliases?.join(', ') || '-'}</td>
                    <td class="p-3 text-sm text-muted">${c.created_at ? new Date(c.created_at).toLocaleDateString() : '-'}</td>
                    <td class="p-3">
                        ${isAdmin ? `
                        <div class="flex gap-2">
                            <button class="btn btn-secondary text-xs py-1 px-2 view-users-btn" data-id="${c.id}">
                                <i class="fas fa-users"></i>
                            </button>
                            <button class="btn btn-secondary text-xs py-1 px-2 text-error-text delete-client-btn" data-id="${c.id}" data-name="${c.name}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('clientList').innerHTML = `
                <h3 class="text-lg font-semibold mb-4">Clients (${clients.length})</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead><tr class="bg-element-hover border-b border-subtle"><th class="p-3 font-medium text-secondary">ID</th><th class="p-3 font-medium text-secondary">Name</th><th class="p-3 font-medium text-secondary">Aliases</th><th class="p-3 font-medium text-secondary">Created</th><th class="p-3 font-medium text-secondary">Actions</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="5" class="p-4 text-center text-muted">No clients</td></tr>'}</tbody>
                    </table>
                </div>
            `;
            
            if (isAdmin) {
                document.querySelectorAll('.delete-client-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const clientId = btn.dataset.id;
                        const clientName = btn.dataset.name;
                        if (!confirm(`Delete client "${clientName}"?`)) return;
                        
                        try {
                            const res = await fetch(`${API_BASE}/clients/${clientId}?delete_documents=false`, {
                                method: 'DELETE',
                                headers: getHeaders(),
                            });
                            if (!res.ok) throw new Error((await res.json()).detail || 'Failed');
                            loadClientList();
                        } catch (err) { alert(err.message); }
                    });
                });
                
                document.querySelectorAll('.view-users-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const clientId = btn.dataset.id;
                        document.getElementById('accessClientSelect').value = clientId;
                        loadClientUsersPreview();
                        document.getElementById('userAccessPanel').scrollIntoView({ behavior: 'smooth' });
                    });
                });
            }
        } catch (err) {
            document.getElementById('clientList').innerHTML = `<div class="p-4 text-error-text bg-error-bg rounded-md">${err.message}</div>`;
        }
    }

    // ============================================================
    // EVALUATION TAB
    // ============================================================
    async function renderEvaluation() {
        content.innerHTML = `
            <div class="flex flex-col gap-6">
                <div class="panel" id="datasetPanel"><div class="loading-spinner"></div></div>
                <div class="panel" id="runPanel"><div class="loading-spinner"></div></div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="panel">
                        <h3 class="text-lg font-semibold mb-4">Generate Dataset</h3>
                        <div class="flex flex-col gap-4">
                            <div><label class="block text-sm font-medium mb-1 text-secondary">Name</label><input id="dsName" placeholder="Daily sample" /></div>
                            <div><label class="block text-sm font-medium mb-1 text-secondary">Client Id (optional)</label><input id="dsClient" placeholder="client-123" /></div>
                            <div><label class="block text-sm font-medium mb-1 text-secondary">Sample Size</label><input id="dsSize" type="number" min="1" max="500" placeholder="50" /></div>
                            <div class="flex items-center gap-4 mt-2">
                                <button class="btn btn-primary" id="genBtn">Generate</button>
                                <span id="genMsg" class="text-sm text-muted"></span>
                            </div>
                        </div>
                    </div>
                    <div class="panel">
                        <h3 class="text-lg font-semibold mb-4">Run Evaluation</h3>
                        <div class="flex flex-col gap-4">
                            <div><label class="block text-sm font-medium mb-1 text-secondary">Dataset Id</label><input id="runDataset" type="number" /></div>
                            <div><label class="block text-sm font-medium mb-1 text-secondary">k</label><input id="runK" type="number" value="5" min="1" max="20" /></div>
                            <div class="flex items-center gap-4 mt-2">
                                <button class="btn btn-primary" id="runBtn">Run</button>
                                <span id="runMsg" class="text-sm text-muted"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;

        document.getElementById('genBtn').addEventListener('click', async () => {
            const name = document.getElementById('dsName').value.trim();
            const client_id = document.getElementById('dsClient').value.trim() || null;
            const sample_size = parseInt(document.getElementById('dsSize').value, 10) || null;
            const msg = document.getElementById('genMsg');
            msg.textContent = '...';
            try {
                const res = await fetch(`${API_BASE}/evaluation/datasets`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ name, client_id, sample_size }),
                });
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed');
                msg.textContent = 'Dataset created';
                msg.className = 'text-sm text-success-text';
                renderEvaluation();
            } catch (err) {
                msg.textContent = err.message;
                msg.className = 'text-sm text-error-text';
            }
        });

        document.getElementById('runBtn').addEventListener('click', async () => {
            const dataset_id = parseInt(document.getElementById('runDataset').value, 10);
            const k = parseInt(document.getElementById('runK').value, 10) || 5;
            const msg = document.getElementById('runMsg');
            msg.textContent = '...';
            try {
                const res = await fetch(`${API_BASE}/evaluation/runs`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ dataset_id, k }),
                });
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed');
                msg.textContent = 'Run completed';
                msg.className = 'text-sm text-success-text';
                renderEvaluation();
            } catch (err) {
                msg.textContent = err.message;
                msg.className = 'text-sm text-error-text';
            }
        });

        try {
            const dsRes = await fetch(`${API_BASE}/evaluation/datasets`, { headers: getHeaders() });
            const dsData = dsRes.ok ? await dsRes.json() : { datasets: [] };
            const datasets = dsData.datasets || [];
            const dsRows = datasets.map(d => `
                <tr class="border-b border-subtle last:border-0">
                    <td class="p-3">${d.id}</td><td class="p-3 font-medium">${d.name}</td><td class="p-3 text-muted">${d.client_id || '-'}</td><td class="p-3">${d.sample_size}</td><td class="p-3">${d.qa_pairs_count}</td><td class="p-3">${d.run_count || 0}</td>
                </tr>
            `).join('');
            document.getElementById('datasetPanel').innerHTML = `
                <h3 class="text-lg font-semibold mb-4">Datasets</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead><tr class="bg-element-hover border-b border-subtle"><th class="p-3 font-medium text-secondary">ID</th><th class="p-3 font-medium text-secondary">Name</th><th class="p-3 font-medium text-secondary">Client</th><th class="p-3 font-medium text-secondary">Sample</th><th class="p-3 font-medium text-secondary">Q&A</th><th class="p-3 font-medium text-secondary">Runs</th></tr></thead>
                        <tbody>${dsRows || '<tr><td colspan="6" class="p-4 text-center text-muted">No datasets</td></tr>'}</tbody>
                    </table>
                </div>
            `;
        } catch (err) {
            document.getElementById('datasetPanel').innerHTML = `<div class="text-error-text">${err.message}</div>`;
        }

        try {
            const runRes = await fetch(`${API_BASE}/evaluation/runs`, { headers: getHeaders() });
            const runData = runRes.ok ? await runRes.json() : { runs: [] };
            const runs = runData.runs || [];
            const runRows = runs.map(r => {
                const m = r.metrics || {};
                return `
                <tr class="border-b border-subtle last:border-0">
                    <td class="p-3">${r.id}</td>
                    <td class="p-3 font-medium">${r.dataset_name || r.dataset_id}</td>
                    <td class="p-3"><span class="px-2 py-0.5 rounded bg-element-active text-xs">${r.status || 'completed'}</span></td>
                    <td class="p-3 font-mono text-sm">${m.mean_precision_at_k?.toFixed?.(3) || '-'}</td>
                    <td class="p-3 font-mono text-sm">${m.mean_recall_at_k?.toFixed?.(3) || '-'}</td>
                    <td class="p-3 font-mono text-sm">${m.mean_mrr?.toFixed?.(3) || '-'}</td>
                    <td class="p-3 font-mono text-sm">${m.hit_rate?.toFixed?.(3) || '-'}</td>
                    <td class="p-3 text-sm text-muted">${r.created_at ? new Date(r.created_at).toLocaleDateString() : ''}</td>
                </tr>
            `}).join('');
            document.getElementById('runPanel').innerHTML = `
                <h3 class="text-lg font-semibold mb-4">Evaluation Runs</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead><tr class="bg-element-hover border-b border-subtle"><th class="p-3 font-medium text-secondary">ID</th><th class="p-3 font-medium text-secondary">Dataset</th><th class="p-3 font-medium text-secondary">Status</th><th class="p-3 font-medium text-secondary">P@k</th><th class="p-3 font-medium text-secondary">R@k</th><th class="p-3 font-medium text-secondary">MRR</th><th class="p-3 font-medium text-secondary">Hit Rate</th><th class="p-3 font-medium text-secondary">Date</th></tr></thead>
                        <tbody>${runRows || '<tr><td colspan="8" class="p-4 text-center text-muted">No runs yet</td></tr>'}</tbody>
                    </table>
                </div>
            `;
        } catch (err) {
            document.getElementById('runPanel').innerHTML = `<div class="text-error-text">${err.message}</div>`;
        }
    }

    // ============================================================
    // STATS TAB
    // ============================================================
    async function renderStats() {
        content.innerHTML = `
            <div class="flex flex-col gap-6">
                <div class="panel" id="statPanel"><div class="loading-spinner"></div></div>
                <div class="panel" id="configPanel"><div class="loading-spinner"></div></div>
            </div>`;
            
        try {
            const res = await fetch(`${API_BASE}/admin/stats`, { headers: getHeaders() });
            const data = res.ok ? await res.json() : {};
            document.getElementById('statPanel').innerHTML = `
                <h3 class="text-lg font-semibold mb-4">Key Stats</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="p-4 rounded bg-element border border-subtle"><div class="text-xs font-medium text-secondary uppercase tracking-wider mb-1">Users</div><div class="text-2xl font-bold">${data.total_users ?? '-'}</div></div>
                    <div class="p-4 rounded bg-element border border-subtle"><div class="text-xs font-medium text-secondary uppercase tracking-wider mb-1">Active</div><div class="text-2xl font-bold">${data.active_users ?? '-'}</div></div>
                    <div class="p-4 rounded bg-element border border-subtle"><div class="text-xs font-medium text-secondary uppercase tracking-wider mb-1">Admins</div><div class="text-2xl font-bold">${data.superusers ?? '-'}</div></div>
                    <div class="p-4 rounded bg-element border border-subtle"><div class="text-xs font-medium text-secondary uppercase tracking-wider mb-1">Req (24h)</div><div class="text-2xl font-bold">${data.total_requests_24h ?? '-'}</div></div>
                    <div class="p-4 rounded bg-element border border-subtle"><div class="text-xs font-medium text-secondary uppercase tracking-wider mb-1">Errors</div><div class="text-2xl font-bold">${data.error_rate_24h ?? '-'}%</div></div>
                    <div class="p-4 rounded bg-element border border-subtle"><div class="text-xs font-medium text-secondary uppercase tracking-wider mb-1">Latency</div><div class="text-2xl font-bold">${data.avg_response_time_ms ?? '-'} ms</div></div>
                </div>
            `;
        } catch (err) {
            document.getElementById('statPanel').innerHTML = `<div class="text-error-text">${err.message}</div>`;
        }

        try {
            const res = await fetch(`${API_BASE}/admin/config`, { headers: getHeaders() });
            const cfg = res.ok ? await res.json() : {};
            const entries = Object.entries(cfg).map(([k,v]) => `<tr class="border-b border-subtle last:border-0"><td class="p-3 font-mono text-sm text-secondary w-1/3">${k}</td><td class="p-3 font-mono text-sm">${v}</td></tr>`).join('');
            document.getElementById('configPanel').innerHTML = `
                <h3 class="text-lg font-semibold mb-4">Configuration</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <tbody>${entries || '<tr><td class="p-4 text-center text-muted">No config</td></tr>'}</tbody>
                    </table>
                </div>
            `;
        } catch (err) {
            document.getElementById('configPanel').innerHTML = `<div class="text-error-text">${err.message}</div>`;
        }
    }

    // Check auth and redirect if needed
    bootstrap();
</script>
</body>
</html>
