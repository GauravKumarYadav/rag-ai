<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar open" id="sidebar">
            <div class="sidebar-header">
                <div class="flex items-center gap-2 font-semibold">
                    <div class="w-8 h-8 rounded bg-accent-solid text-inverse flex items-center justify-center">
                        <i class="fas fa-robot"></i>
                    </div>
                    <span>AI Chat</span>
                </div>
                <button class="btn btn-primary w-full mt-4" id="newChatBtn">
                    <i class="fas fa-plus"></i> New Chat
                </button>
            </div>
            
            <div class="sidebar-content">
                <div class="text-xs font-medium text-secondary uppercase tracking-wider mb-2 px-2">Recent</div>
                <div class="flex flex-col gap-1" id="conversationList">
                    <!-- Conversations injected here -->
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="flex items-center gap-2 p-2 rounded hover:bg-element-hover cursor-pointer transition-colors" id="userMenu">
                    <div class="w-8 h-8 rounded-full bg-accent-solid text-inverse flex items-center justify-center text-sm font-bold" id="userAvatar">U</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium truncate" id="userName">User</div>
                        <div class="text-xs text-secondary">Online</div>
                    </div>
                    <button class="btn btn-ghost p-1 text-secondary" id="settingsBtn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="chat-header">
                <div class="flex items-center gap-3">
                    <button class="btn btn-ghost p-1" id="mobileMenuBtn" title="Toggle sidebar"><i class="fas fa-bars"></i></button>
                    <h3 class="font-semibold text-sm md:text-base truncate max-w-[200px]" id="chatTitle">New Conversation</h3>
                    <span class="text-xs px-2 py-0.5 rounded bg-element-active border border-subtle text-secondary" id="modelBadge">AI Model</span>
                </div>
                
                <div class="flex items-center gap-2 md:gap-4">
                    <div class="flex items-center gap-2">
                        <label for="chatClientSelect" class="text-xs text-secondary hidden md:block uppercase tracking-wider">Context</label>
                        <select class="text-sm py-1 pl-2 pr-8 border border-subtle rounded bg-element" id="chatClientSelect">
                            <!-- Options injected -->
                        </select>
                    </div>
                    
                    <div class="h-4 w-px bg-border-subtle mx-1"></div>
                    
                    <div class="flex items-center gap-2 text-xs text-secondary">
                        <span class="w-2 h-2 rounded-full bg-border-focus" id="statusDot"></span>
                        <span id="statusText" class="hidden md:inline">Connecting...</span>
                    </div>
                    
                    <button class="btn btn-secondary p-2" id="docsBtn" title="Knowledge Base">
                        <i class="fas fa-folder-open"></i>
                    </button>
                </div>
            </header>

            <!-- Chat Area -->
            <div class="chat-messages" id="chatMessages">
                <!-- Welcome State -->
                <div class="flex flex-col items-center justify-center h-full p-8" id="welcomeState">
                    <div class="w-16 h-16 rounded-2xl bg-element border border-subtle flex items-center justify-center text-3xl text-primary mb-6 shadow-sm">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-4 text-center">Your AI-Powered Knowledge Assistant</h2>
                    
                    <div class="max-w-2xl w-full">
                        <p class="text-secondary mb-6 text-center">Upload documents for any client and instantly query their information. Here's what you can do:</p>
                        
                        <div class="bg-element border border-subtle rounded-xl p-6 mb-6">
                            <h3 class="font-semibold text-primary mb-4 flex items-center gap-2">
                                <i class="fas fa-briefcase"></i> Business Use Cases
                            </h3>
                            <ul class="space-y-3 text-sm">
                                <li class="flex items-start gap-3">
                                    <i class="fas fa-check-circle text-accent-solid mt-0.5"></i>
                                    <span><strong>Client Document Management</strong> — Upload and organize documents per client for quick retrieval</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <i class="fas fa-check-circle text-accent-solid mt-0.5"></i>
                                    <span><strong>Instant Information Lookup</strong> — Ask questions about any uploaded document and get accurate answers</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <i class="fas fa-check-circle text-accent-solid mt-0.5"></i>
                                    <span><strong>Cross-Document Analysis</strong> — Compare information across multiple documents within a client context</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <i class="fas fa-check-circle text-accent-solid mt-0.5"></i>
                                    <span><strong>Compliance & Audit Support</strong> — Quickly find specific clauses, terms, or data points from contracts and legal documents</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <i class="fas fa-check-circle text-accent-solid mt-0.5"></i>
                                    <span><strong>Knowledge Extraction</strong> — Extract key insights, summaries, or specific data from PDFs, docs, and text files</span>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="bg-element border border-subtle rounded-xl p-6">
                            <h3 class="font-semibold text-primary mb-4 flex items-center gap-2">
                                <i class="fas fa-lightbulb"></i> How to Use
                            </h3>
                            <ol class="space-y-3 text-sm list-decimal list-inside">
                                <li><strong>Select a Client</strong> — Choose or create a client from the dropdown above</li>
                                <li><strong>Upload Documents</strong> — Use the Knowledge Base panel to upload relevant files</li>
                                <li><strong>Ask Questions</strong> — Type your query below to get AI-powered answers from your documents</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator hidden" id="typingIndicator">
                    <div class="flex items-center gap-2 p-3 rounded-lg bg-element border border-subtle w-fit">
                        <div class="flex gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-text-tertiary animate-bounce"></span>
                            <span class="w-1.5 h-1.5 rounded-full bg-text-tertiary animate-bounce" style="animation-delay: 0.1s"></span>
                            <span class="w-1.5 h-1.5 rounded-full bg-text-tertiary animate-bounce" style="animation-delay: 0.2s"></span>
                        </div>
                        <span class="text-xs text-secondary">Thinking...</span>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Type your message here..."
                        rows="1"
                    ></textarea>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-primary p-2 rounded-md h-8 w-8 flex items-center justify-center" id="sendBtn" disabled>
                            <i class="fas fa-arrow-up text-xs"></i>
                        </button>
                    </div>
                </div>
                <div class="text-center mt-2 text-xs text-tertiary">
                    Press Enter to send, Shift+Enter for new line
                </div>
            </div>
        </main>
    </div>

    <!-- Documents Panel -->
    <div class="documents-panel" id="documentsPanel">
        <div class="flex items-center justify-between p-4 border-b border-subtle">
            <h3 class="font-semibold flex items-center gap-2">
                <i class="fas fa-folder-open text-secondary"></i> Knowledge Base
            </h3>
            <button class="btn btn-ghost p-1" id="closePanelBtn"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="p-4 border-b border-subtle bg-bg-app">
            <label class="text-xs font-medium text-secondary uppercase tracking-wider mb-2 block">Context / Client</label>
            <div class="flex gap-2">
                <select class="flex-1 text-sm p-2 border border-subtle rounded bg-element" id="clientSelect">
                    <!-- Options injected -->
                </select>
                <button class="btn btn-secondary p-2" id="addClientBtn" title="Add Client">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4">
            <div class="border-2 border-dashed border-border-subtle rounded-lg p-6 text-center hover:border-accent-solid hover:bg-element-hover transition-all cursor-pointer mb-6" id="uploadZone">
                <i class="fas fa-cloud-upload-alt text-2xl text-secondary mb-2" id="uploadIcon"></i>
                <p class="text-sm font-medium" id="uploadText">Drag & drop files</p>
                <p class="text-xs text-secondary mt-1" id="uploadHint">or click to browse</p>
                <input type="file" id="fileInput" hidden multiple accept=".pdf,.txt,.md,.doc,.docx,.png,.jpg,.jpeg">
                
                <div class="mt-4 pt-4 border-t border-subtle text-left">
                    <label class="flex items-center gap-2 text-xs text-secondary mb-2 cursor-pointer">
                        <input type="checkbox" id="useOcrCheckbox" checked class="accent-accent-solid"> Enable OCR
                    </label>
                    <label class="flex items-center gap-2 text-xs text-secondary cursor-pointer">
                        <input type="checkbox" id="fastModeCheckbox" class="accent-accent-solid"> Fast mode
                    </label>
                </div>

                <div class="hidden mt-4" id="uploadProgress">
                    <div class="h-1.5 w-full bg-border-subtle rounded-full overflow-hidden">
                        <div class="h-full bg-accent-solid transition-all duration-300" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="text-xs text-secondary mt-2" id="progressText">Uploading...</div>
                </div>
            </div>

            <div class="text-xs font-medium text-secondary uppercase tracking-wider mb-3">Uploaded Documents <span id="docsClientName" class="text-primary font-semibold"></span></div>
            <div class="flex flex-col gap-2" id="documentList">
                <!-- Documents injected -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold">Settings</h3>
                <button id="closeSettingsBtn" class="btn btn-ghost p-1"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex flex-col gap-6">
                <div class="flex items-center justify-between p-3 rounded-lg border border-subtle bg-element">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-bg-app border border-subtle flex items-center justify-center">
                            <i class="fas fa-moon"></i>
                        </div>
                        <div>
                            <div class="font-medium text-sm">Dark Mode</div>
                            <div class="text-xs text-secondary">Switch between light and dark themes</div>
                        </div>
                    </div>
                    <button id="themeToggleBtn" class="btn btn-secondary text-xs">
                        Toggle
                    </button>
                </div>

                <div class="flex items-center justify-between p-3 rounded-lg border border-subtle bg-element">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-bg-app border border-subtle flex items-center justify-center">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div class="font-medium text-sm">Profile</div>
                            <div class="text-xs text-secondary">Manage account settings</div>
                        </div>
                    </div>
                    <button onclick="window.location.href='/profile'" class="btn btn-secondary text-xs">
                        Manage
                    </button>
                </div>
                
                <button id="logoutBtnModal" class="btn btn-ghost text-error-text w-full justify-center border border-error-bg hover:bg-error-bg">
                    Sign Out
                </button>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">New Client</h3>
                <button id="closeClientModal" class="btn btn-ghost p-1"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1 text-secondary">Client Name</label>
                <input type="text" id="clientName" placeholder="Enter client name" required>
            </div>
            <div class="flex gap-2 justify-end">
                <button class="btn btn-ghost" id="cancelClientBtn">Cancel</button>
                <button class="btn btn-primary" id="createClientBtn">Create</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="fixed top-4 right-4 z-50 flex flex-col gap-2" id="toastContainer"></div>

    <!-- Loading Overlay -->
    <div class="fixed inset-0 bg-bg-app/80 backdrop-blur-sm z-50 hidden flex-col items-center justify-center" id="loadingOverlay">
        <div class="loading-spinner w-12 h-12 border-4"></div>
        <div class="mt-4 text-secondary font-medium" id="loadingText">Loading...</div>
    </div>

    <script>
        // Initialize Theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // ============================================================
        // Configuration
        // ============================================================
        const API_BASE = window.location.origin;
        const WS_BASE = 'ws://localhost:8000';
        
        // ============================================================
        // State
        // ============================================================
        let authToken = localStorage.getItem('auth_token');
        let currentUser = null;
        let currentConversationId = null;
        let currentClientId = localStorage.getItem('current_client_id') || '';
        let clients = [];
        let websocket = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // ============================================================
        // DOM Elements
        // ============================================================
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const conversationList = document.getElementById('conversationList');
        const welcomeState = document.getElementById('welcomeState');
        const typingIndicator = document.getElementById('typingIndicator');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const documentsPanel = document.getElementById('documentsPanel');
        const docsBtn = document.getElementById('docsBtn');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const documentList = document.getElementById('documentList');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        
        // Settings Modal Elements
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const logoutBtnModal = document.getElementById('logoutBtnModal');

        // ============================================================
        // Utility Functions
        // ============================================================
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            // Tailwind classes for toast
            const bgClass = type === 'error' ? 'bg-error-bg text-error-text border-error-text/20' : 'bg-element text-primary border-border-subtle';
            toast.className = `p-4 rounded-lg border shadow-lg text-sm animate-in slide-in-from-right-full fade-in duration-300 ${bgClass}`;
            toast.innerHTML = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            text.textContent = message;
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }

        function showUploadProgress(current, total, filename) {
            const progress = document.getElementById('uploadProgress');
            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');
            const icon = document.getElementById('uploadIcon');
            const uploadText = document.getElementById('uploadText');
            const hint = document.getElementById('uploadHint');
            
            progress.classList.remove('hidden');
            icon.className = 'fas fa-spinner fa-spin text-2xl text-accent-solid mb-2';
            uploadText.textContent = 'Uploading...';
            hint.style.display = 'none';
            
            const percent = Math.round((current / total) * 100);
            bar.style.width = percent + '%';
            text.textContent = `Uploading ${filename} (${current}/${total})`;
        }

        function hideUploadProgress() {
            const progress = document.getElementById('uploadProgress');
            const icon = document.getElementById('uploadIcon');
            const uploadText = document.getElementById('uploadText');
            const hint = document.getElementById('uploadHint');
            
            progress.classList.add('hidden');
            icon.className = 'fas fa-cloud-upload-alt text-2xl text-secondary mb-2';
            uploadText.textContent = 'Drag & drop files';
            hint.style.display = 'block';
        }

        function showSectionLoading(element) {
            if (element) {
                element.innerHTML = `
                    <div class="text-center p-4 text-secondary text-xs">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                    </div>
                `;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            if (!bytes) return '';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // ============================================================
        // Authentication
        // ============================================================
        function redirectToLogin() {
            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
        }

        async function checkAuth() {
            if (!authToken) {
                redirectToLogin();
                return false;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    currentUser = await response.json();
                    userName.textContent = currentUser.username;
                    userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
                    initializeApp();
                    return true;
                } else {
                    logout();
                    return false;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                logout();
                return false;
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            if (websocket) websocket.close();
            redirectToLogin();
        }

        // ============================================================
        // WebSocket Connection
        // ============================================================
        function connectWebSocket() {
            if (!authToken || !currentConversationId) return;

            const wsClientId = currentClientId || 'global';
            const wsUrl = `${WS_BASE}/chat/ws/${wsClientId}?token=${authToken}`;
            websocket = new WebSocket(wsUrl);

            websocket.onopen = () => {
                reconnectAttempts = 0;
            };

            websocket.onclose = () => {
                if (isWaitingForResponse) {
                    isWaitingForResponse = false;
                    currentStreamingMessage = null;
                    sendBtn.disabled = false;
                    hideTypingIndicator();
                }
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                }
            };

            websocket.onerror = () => {
                console.warn('WebSocket error - will retry');
                if (isWaitingForResponse) {
                    isWaitingForResponse = false;
                    currentStreamingMessage = null;
                    sendBtn.disabled = false;
                    hideTypingIndicator();
                    showToast('Connection lost, please try again', 'error');
                }
            };

            websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                statusDot.classList.remove('bg-error-bg', 'bg-border-focus');
                statusDot.classList.add('bg-success-text');
                statusText.textContent = 'Ready';
            } else {
                statusDot.classList.remove('bg-success-text', 'bg-border-focus');
                statusDot.classList.add('bg-error-text');
                statusText.textContent = 'Offline';
            }
        }

        let currentStreamingMessage = null;
        let isWaitingForResponse = false;

        function handleWebSocketMessage(data) {
            if (data.type === 'chunk' || data.type === 'stream') {
                if (!currentStreamingMessage) {
                    hideTypingIndicator();
                    currentStreamingMessage = createAssistantMessage('');
                }
                appendToStreamingMessage(data.content);
            } else if (data.type === 'done' || data.type === 'complete') {
                if (currentStreamingMessage) {
                    const contentDiv = currentStreamingMessage.querySelector('.message-content');
                    contentDiv.innerHTML = marked.parse(contentDiv.textContent);
                    // Add copy buttons to code blocks
                    addCopyButtons(contentDiv);
                }
                currentStreamingMessage = null;
                isWaitingForResponse = false;
                hideTypingIndicator();
                sendBtn.disabled = false;
                loadConversations();
            } else if (data.type === 'error') {
                currentStreamingMessage = null;
                isWaitingForResponse = false;
                hideTypingIndicator();
                sendBtn.disabled = false;
                showToast(data.detail || data.message || 'An error occurred', 'error');
            }
        }

        // ============================================================
        // Chat Functions
        // ============================================================
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            if (isWaitingForResponse || sendBtn.disabled) return;

            chatInput.value = '';
            autoResizeInput();
            sendBtn.disabled = true;
            isWaitingForResponse = true;
            currentStreamingMessage = null;

            welcomeState.style.display = 'none';

            if (!currentConversationId) {
                try {
                    await createConversation();
                } catch (error) {
                    sendBtn.disabled = false;
                    isWaitingForResponse = false;
                    return;
                }
            }

            addMessage('user', message);
            showTypingIndicator();

            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ 
                    type: 'chat', 
                    message: message,
                    conversation_id: currentConversationId
                }));
            } else {
                await sendMessageREST(message);
            }
        }

        async function sendMessageREST(message) {
            try {
                const requestBody = {
                    message: message,
                    stream: false
                };
                if (currentConversationId) {
                    requestBody.conversation_id = currentConversationId;
                }
                if (currentClientId) {
                    requestBody.client_id = currentClientId;
                }
                
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const data = await response.json();
                    hideTypingIndicator();
                    sendBtn.disabled = false;
                    isWaitingForResponse = false;
                    addMessage('assistant', data.response);
                    loadConversations();
                } else if (response.status === 401) {
                    sendBtn.disabled = false;
                    isWaitingForResponse = false;
                    logout();
                } else {
                    hideTypingIndicator();
                    sendBtn.disabled = false;
                    isWaitingForResponse = false;
                    const error = await response.json().catch(() => ({}));
                    showToast(error.detail || 'Failed to send message', 'error');
                }
            } catch (error) {
                hideTypingIndicator();
                sendBtn.disabled = false;
                isWaitingForResponse = false;
                console.error('Chat error:', error);
                showToast('Connection error', 'error');
            }
        }

        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = role === 'user' 
                ? `<i class="fas fa-user"></i>`
                : `<i class="fas fa-robot"></i>`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = role === 'assistant' ? marked.parse(content) : escapeHtml(content);
            
            if (role === 'assistant') {
                addCopyButtons(contentDiv);
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.insertBefore(messageDiv, typingIndicator);
            scrollToBottom();
            
            return messageDiv;
        }

        function createAssistantMessage(initialContent) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = `<i class="fas fa-robot"></i>`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = initialContent;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.insertBefore(messageDiv, typingIndicator);
            scrollToBottom();
            
            return messageDiv;
        }

        function appendToStreamingMessage(content) {
            if (currentStreamingMessage) {
                const contentDiv = currentStreamingMessage.querySelector('.message-content');
                contentDiv.textContent += content;
                scrollToBottom();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showTypingIndicator() {
            typingIndicator.classList.remove('hidden');
            scrollToBottom();
        }

        function hideTypingIndicator() {
            typingIndicator.classList.add('hidden');
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ============================================================
        // Conversations
        // ============================================================
        async function loadConversations() {
            try {
                const response = await fetch(`${API_BASE}/conversations`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    const conversations = data.conversations || data || [];
                    renderConversations(conversations);
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
            }
        }

        function renderConversations(conversationsList) {
            const conversations = Array.isArray(conversationsList) ? conversationsList : [];
            conversationList.innerHTML = '';
            
            if (conversations.length === 0) {
                conversationList.innerHTML = `
                    <div class="text-center p-4 text-secondary text-xs">
                        No conversations yet
                    </div>
                `;
                return;
            }

            conversations.forEach(conv => {
                const item = document.createElement('div');
                // Updated classes for new design
                const activeClass = conv.id === currentConversationId ? 'bg-element-active text-primary' : 'hover:bg-element-hover text-secondary';
                item.className = `flex items-center gap-2 p-2 rounded cursor-pointer transition-colors group ${activeClass}`;
                item.innerHTML = `
                    <i class="fas fa-message text-xs opacity-70"></i>
                    <span class="flex-1 text-sm truncate">${conv.title || 'New Conversation'}</span>
                    <button class="delete-btn opacity-0 group-hover:opacity-100 p-1 hover:text-error-text transition-opacity" data-id="${conv.id}">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                `;
                item.onclick = (e) => {
                    if (!e.target.closest('.delete-btn')) {
                        selectConversation(conv.id);
                    }
                };
                item.querySelector('.delete-btn').onclick = (e) => {
                    e.stopPropagation();
                    deleteConversation(conv.id);
                };
                conversationList.appendChild(item);
            });
        }

        async function createConversation() {
            try {
                const response = await fetch(`${API_BASE}/conversations`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ title: 'New Conversation' })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentConversationId = data.id;
                    connectWebSocket();
                    loadConversations();
                } else if (response.status === 401) {
                    logout();
                    throw new Error('Unauthorized');
                } else {
                    throw new Error('Failed to create conversation');
                }
            } catch (error) {
                showToast('Failed to create conversation', 'error');
                throw error;
            }
        }

        async function selectConversation(id) {
            currentConversationId = id;
            currentStreamingMessage = null;
            isWaitingForResponse = false;
            sendBtn.disabled = false;
            if (websocket) websocket.close();
            
            chatMessages.querySelectorAll('.message').forEach(m => m.remove());
            welcomeState.style.display = 'none';
            showTypingIndicator();
            document.getElementById('chatTitle').textContent = 'Loading...';
            
            // Highlight active conversation
            const items = conversationList.querySelectorAll('div');
            items.forEach(item => {
                // Reset classes
                item.className = 'flex items-center gap-2 p-2 rounded cursor-pointer transition-colors group hover:bg-element-hover text-secondary';
            });
            // This is a bit hacky, ideally re-render, but for speed:
            loadConversations(); // Re-render to update active state correctly

            await loadConversationHistory(id);
            hideTypingIndicator();
            connectWebSocket();
        }

        async function loadConversationHistory(id) {
            try {
                const response = await fetch(`${API_BASE}/conversations/${id}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('chatTitle').textContent = data.title || 'Conversation';
                    
                    if (data.messages) {
                        data.messages.forEach(msg => {
                            addMessage(msg.role, msg.content);
                        });
                    }
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Failed to load history:', error);
                document.getElementById('chatTitle').textContent = 'Conversation';
            }
        }

        async function deleteConversation(id) {
            if (!confirm('Delete this conversation?')) return;

            showLoading('Deleting conversation...');
            try {
                const response = await fetch(`${API_BASE}/conversations/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                hideLoading();
                if (response.ok) {
                    if (currentConversationId === id) {
                        newChat();
                    }
                    loadConversations();
                    showToast('Conversation deleted', 'success');
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                hideLoading();
                showToast('Failed to delete', 'error');
            }
        }

        function newChat() {
            currentConversationId = null;
            currentStreamingMessage = null;
            isWaitingForResponse = false;
            sendBtn.disabled = false;
            if (websocket) websocket.close();
            chatMessages.querySelectorAll('.message').forEach(m => m.remove());
            welcomeState.style.display = 'flex'; // Use flex to restore layout
            document.getElementById('chatTitle').textContent = 'New Conversation';
            hideTypingIndicator();
            loadConversations();
        }

        // ============================================================
        // Documents
        // ============================================================
        async function loadDocuments() {
            showSectionLoading(documentList);
            
            // Show which client's documents we're viewing
            const clientNameEl = document.getElementById('docsClientName');
            const selectedClient = clients.find(c => c.id === currentClientId);
            if (clientNameEl) {
                clientNameEl.textContent = selectedClient ? `(${selectedClient.name})` : '';
            }
            
            try {
                let url = `${API_BASE}/documents`;
                if (currentClientId) {
                    url += `?client_id=${currentClientId}`;
                }
                
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const documents = await response.json();
                    renderDocuments(documents);
                } else if (response.status === 401) {
                    logout();
                } else {
                    renderDocuments([]);
                }
            } catch (error) {
                renderDocuments([]);
            }
        }

        function renderDocuments(documents) {
            if (!documents || documents.length === 0) {
                documentList.innerHTML = `
                    <div class="text-center p-4 text-secondary text-xs">
                        No documents uploaded
                    </div>
                `;
                return;
            }

            documentList.innerHTML = '';
            documents.forEach(doc => {
                const item = document.createElement('div');
                item.className = 'document-item flex items-center gap-3 p-3 rounded bg-element border border-subtle';
                const meta = doc.chunk_count ? `${doc.chunk_count} chunks` : formatFileSize(doc.size || 0);
                const clientInfo = doc.client_name ? ` • ${doc.client_name}` : '';
                item.innerHTML = `
                    <i class="fas fa-file-alt text-primary"></i>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium truncate">${doc.filename || doc.name || 'Document'}</div>
                        <div class="text-xs text-secondary">${meta}${clientInfo}</div>
                    </div>
                    <button class="delete-doc-btn p-1 text-secondary hover:text-error-text transition-colors" data-id="${doc.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                item.querySelector('.delete-doc-btn').onclick = () => deleteDocument(doc.id);
                documentList.appendChild(item);
            });
        }

        async function uploadFiles(files) {
            const totalFiles = files.length;
            let uploadedCount = 0;
            
            const useOcr = document.getElementById('useOcrCheckbox')?.checked ?? true;
            const fastMode = document.getElementById('fastModeCheckbox')?.checked ?? false;
            
            for (const file of files) {
                uploadedCount++;
                showUploadProgress(uploadedCount, totalFiles, file.name);
                
                const formData = new FormData();
                formData.append('files', file);
                formData.append('use_ocr', useOcr);
                formData.append('fast_mode', fastMode);
                
                if (currentClientId) {
                    formData.append('client_id', currentClientId);
                }

                try {
                    const response = await fetch(`${API_BASE}/documents/upload`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` },
                        body: formData
                    });

                    if (response.ok) {
                        showToast(`Uploaded: ${file.name}`, 'success');
                    } else if (response.status === 401) {
                        hideUploadProgress();
                        logout();
                        return;
                    } else {
                        const error = await response.json().catch(() => ({}));
                        showToast(`Failed: ${error.detail || file.name}`, 'error');
                    }
                } catch (error) {
                    showToast(`Error uploading: ${file.name}`, 'error');
                }
            }
            hideUploadProgress();
            fileInput.value = '';  // Reset file input for re-upload
            loadDocuments();
        }

        async function deleteDocument(id) {
            showLoading('Deleting document...');
            try {
                const response = await fetch(`${API_BASE}/documents/${encodeURIComponent(id)}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                hideLoading();
                if (response.ok) {
                    showToast('Document deleted', 'success');
                    loadDocuments();
                } else if (response.status === 401) {
                    logout();
                } else {
                    const error = await response.json().catch(() => ({}));
                    showToast(error.detail || 'Failed to delete', 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('Failed to delete', 'error');
            }
        }

        // ============================================================
        // Client Management
        // ============================================================
        async function loadClients() {
            try {
                const response = await fetch(`${API_BASE}/clients/my/assigned`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    clients = data.clients || [];
                    renderClientSelector();
                    renderChatClientSelector();
                } else if (response.status === 401) {
                    logout();
                } else {
                    const fallbackResponse = await fetch(`${API_BASE}/clients`, {
                        headers: getAuthHeaders()
                    });
                    if (fallbackResponse.ok) {
                        const fallbackData = await fallbackResponse.json();
                        clients = fallbackData.clients || [];
                        renderClientSelector();
                        renderChatClientSelector();
                    }
                }
            } catch (error) {
                console.error('Failed to load clients:', error);
            }
        }

        function renderClientSelector() {
            const select = document.getElementById('clientSelect');
            select.innerHTML = '';
            
            // Check if stored client_id exists in current clients list
            const storedClientExists = clients.some(c => c.id === currentClientId);
            if (currentClientId && !storedClientExists) {
                currentClientId = ''; // Reset if stored client doesn't exist
                localStorage.removeItem('current_client_id');
            }
            
            clients.forEach((client, index) => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                if (client.id === currentClientId || (!currentClientId && index === 0)) {
                    option.selected = true;
                    if (!currentClientId && index === 0) {
                        currentClientId = client.id;
                        localStorage.setItem('current_client_id', client.id);
                    }
                }
                select.appendChild(option);
            });
        }

        function renderChatClientSelector() {
            const select = document.getElementById('chatClientSelect');
            if (!select) return;
            
            select.innerHTML = '';
            
            // Check if stored client_id exists in current clients list
            const storedClientExists = clients.some(c => c.id === currentClientId);
            if (currentClientId && !storedClientExists) {
                currentClientId = ''; // Reset if stored client doesn't exist
                localStorage.removeItem('current_client_id');
            }
            
            clients.forEach((client, index) => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                if (client.id === currentClientId || (!currentClientId && index === 0)) {
                    option.selected = true;
                    if (!currentClientId && index === 0) {
                        currentClientId = client.id;
                        localStorage.setItem('current_client_id', client.id);
                    }
                }
                select.appendChild(option);
            });
        }

        async function createClient(name) {
            const createBtn = document.getElementById('createClientBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';
            
            try {
                const response = await fetch(`${API_BASE}/clients`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ name })
                });

                createBtn.disabled = false;
                createBtn.textContent = 'Create';
                
                if (response.ok) {
                    const client = await response.json();
                    showToast(`Client "${name}" created`, 'success');
                    await loadClients();
                    currentClientId = client.id;
                    localStorage.setItem('current_client_id', currentClientId);
                    document.getElementById('clientSelect').value = currentClientId;
                    loadDocuments();
                } else if (response.status === 401) {
                    logout();
                } else {
                    const error = await response.json().catch(() => ({}));
                    showToast(error.detail || 'Failed to create client', 'error');
                }
            } catch (error) {
                createBtn.disabled = false;
                createBtn.textContent = 'Create';
                showToast('Failed to create client', 'error');
            }
        }

        // ============================================================
        // Input Handling
        // ============================================================
        function autoResizeInput() {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';
            sendBtn.disabled = !chatInput.value.trim();
        }

        function useSuggestion(text) {
            chatInput.value = text;
            chatInput.focus();
            autoResizeInput();
        }

        // ============================================================
        // Event Listeners
        // ============================================================
        logoutBtnModal.addEventListener('click', logout);

        chatInput.addEventListener('input', autoResizeInput);

        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);
        newChatBtn.addEventListener('click', newChat);

        // Hamburger menu - toggle sidebar
        document.getElementById('mobileMenuBtn').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('open');
        });

        docsBtn.addEventListener('click', () => {
            documentsPanel.classList.add('open');
            // Sync dropdown with currentClientId
            const clientSelect = document.getElementById('clientSelect');
            if (clientSelect && currentClientId) {
                clientSelect.value = currentClientId;
            }
            loadDocuments();
        });

        closePanelBtn.addEventListener('click', () => {
            documentsPanel.classList.remove('open');
        });

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('border-accent-solid', 'bg-element-hover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('border-accent-solid', 'bg-element-hover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('border-accent-solid', 'bg-element-hover');
            uploadFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            uploadFiles(e.target.files);
        });

        document.getElementById('clientSelect').addEventListener('change', (e) => {
            currentClientId = e.target.value;
            localStorage.setItem('current_client_id', currentClientId);
            const chatSelect = document.getElementById('chatClientSelect');
            if (chatSelect) chatSelect.value = currentClientId;
            loadDocuments();
        });

        document.getElementById('chatClientSelect').addEventListener('change', (e) => {
            currentClientId = e.target.value;
            localStorage.setItem('current_client_id', currentClientId);
            const docsSelect = document.getElementById('clientSelect');
            if (docsSelect) docsSelect.value = currentClientId;
        });

        document.getElementById('addClientBtn').addEventListener('click', () => {
            document.getElementById('clientModal').classList.remove('hidden');
            document.getElementById('clientName').value = '';
            document.getElementById('clientName').focus();
        });

        document.getElementById('closeClientModal').addEventListener('click', () => {
            document.getElementById('clientModal').classList.add('hidden');
        });

        document.getElementById('cancelClientBtn').addEventListener('click', () => {
            document.getElementById('clientModal').classList.add('hidden');
        });

        document.getElementById('createClientBtn').addEventListener('click', async () => {
            const name = document.getElementById('clientName').value.trim();
            if (name) {
                await createClient(name);
                document.getElementById('clientModal').classList.add('hidden');
            }
        });

        document.getElementById('clientName').addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const name = document.getElementById('clientName').value.trim();
                if (name) {
                    await createClient(name);
                    document.getElementById('clientModal').classList.add('hidden');
                }
            }
        });

        // Settings Modal Logic
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update button text (themeToggleBtn might not exist on all pages)
            if (themeToggleBtn) {
                if (newTheme === 'dark') {
                    themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
                } else {
                    themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
                }
            }
        });

        // Copy Code Logic
        // Configure marked to use highlight.js for code blocks
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (e) {}
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        function addCopyButtons(container) {
            container.querySelectorAll('pre').forEach(pre => {
                // Apply syntax highlighting if not already done
                const codeBlock = pre.querySelector('code');
                if (codeBlock && !codeBlock.classList.contains('hljs')) {
                    hljs.highlightElement(codeBlock);
                }
                
                // Extract language from class (e.g., language-python)
                if (codeBlock) {
                    const langClass = Array.from(codeBlock.classList).find(c => c.startsWith('language-'));
                    if (langClass) {
                        pre.setAttribute('data-language', langClass.replace('language-', ''));
                    }
                }
                
                // Add copy button if not already present
                if (pre.querySelector('.code-copy-btn')) return;
                
                const btn = document.createElement('button');
                btn.className = 'code-copy-btn';
                btn.innerHTML = '<i class="fas fa-copy"></i>';
                btn.title = 'Copy code';
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const code = codeBlock?.innerText || pre.innerText;
                    navigator.clipboard.writeText(code);
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => btn.innerHTML = '<i class="fas fa-copy"></i>', 2000);
                };
                pre.style.position = 'relative';
                pre.appendChild(btn);
            });
        }

        // ============================================================
        // Initialize
        // ============================================================
        async function initializeApp() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('modelBadge').textContent = data.model || 'AI Model';
                    updateConnectionStatus(true);
                } else {
                    updateConnectionStatus(false);
                }
            } catch (error) {
                console.error('Failed to get status:', error);
                updateConnectionStatus(false);
            }
            
            await loadConversations();
            await loadClients();
            await loadDocuments();
        }

        // ============================================================
        // Periodic Backend Health Check (every 2 minutes)
        // ============================================================
        async function checkBackendHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                updateConnectionStatus(response.ok);
            } catch (error) {
                updateConnectionStatus(false);
            }
        }

        // Check backend health every 2 minutes (120000ms)
        setInterval(checkBackendHealth, 120000);

        checkAuth();
    </script>
</body>
</html>
